
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análisis y Demo | MNIST AI</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">

    <!-- SDKs de Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

    <!-- Plotly -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/src/decoracion.css">

</head>
<body>
    <div class="container">
        <header class="card">
            <h1>Análisis y Demo de IA para MNIST</h1>
            <p>Esta es una plataforma completa para analizar el rendimiento de un modelo de IA en el dataset MNIST y probarlo con tus propias imágenes.</p>
        </header>

        <main class="main-grid">
            <!-- Columna Izquierda: Predicción -->
            <div class="prediction-column">
                <section class="card prediction-section">
                    <h2>¡Prueba la IA en tiempo real!</h2>
                    <p>Sube una imagen de un número manuscrito. La IA predecirá el dígito y podrás guardar la imagen y el resultado en Firebase.</p>
                    <div id="upload-area" class="upload-area">
                        <p>Haz clic aquí o arrastra una imagen</p>
                        <input type="file" id="image-upload" accept="image/*" style="display: none;">
                    </div>
                    <img id="image-preview" src="" alt="Vista previa de la imagen" style="display:none;"/>
                    <h3>Predicción de la IA:</h3>
                    <div id="prediction-result">...</div>
                    <button id="save-button" class="action-button" disabled>Guardar Resultado en Firebase</button>
                    <div id="status-message"></div>
                </section>
            </div>

            <!-- Columna Derecha: Análisis del Modelo -->
            <div class="analysis-column">
                <section class="card">
                    <h2>Rendimiento del Modelo</h2>
                    <p>Las siguientes gráficas muestran la evolución del modelo durante el entrenamiento, evidenciando el sobreajuste (overfitting).</p>
                    <div class="grid">
                        <div id="accuracy-chart"></div>
                        <div id="loss-chart"></div>
                    </div>
                </section>

                <section class="card">
                    <h2>Análisis de Errores: Matriz de Confusión</h2>
                    <p>La matriz de confusión revela los aciertos (diagonal) y los errores específicos de clasificación del modelo.</p>
                    <div id="confusion-matrix-chart"></div>
                    <p class="final-accuracy">{{ final_accuracy }}</p>
                </section>

                <section class="card">
                    <h2>Ejemplos de Predicciones</h2>
                    <p>Aciertos (verde) y errores (rojo) del modelo sobre el conjunto de prueba.</p>
                    <div class="image-gallery">
                        {% for sample in sample_images %}
                        <div class="sample-item">
                            <img src="{{ sample.image }}" alt="Dígito {{ sample.true_label }}">
                            <div class="prediction-label {% if sample.predicted_label == sample.true_label %}prediction-correct{% else %}prediction-incorrect{% endif %}">
                                Real: {{ sample.true_label }} | Pred: {{ sample.predicted_label }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </section>

                <section class="card">
                    <h2>Detalles Técnicos del Modelo</h2>
                    <h3>Arquitectura</h3>
                    <pre>{{ model_summary }}</pre>
                    <h3>Logs de Entrenamiento</h3>
                    <pre>{% for log in training_logs %}{{ log }}
{% endfor %}</pre>
                </section>
            </div>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- 1. INICIALIZACIÓN DE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCIEnLMa3UQCCw6AMySmdHB1dACS057OqU",
            authDomain: "fir-data-bc4ad.firebaseapp.com",
            projectId: "fir-data-bc4ad",
            storageBucket: "fir-data-bc4ad.appspot.com",
            messagingSenderId: "547852821097",
            appId: "1:547852821097:web:360dda0f153de9a748f8f8",
            measurementId: "G-YSKT7F8HTX"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();
        const db = firebase.firestore();

        // --- 2. RENDERIZADO DE GRÁFICOS PLOTLY (con tema oscuro) ---
        function applyDarkTheme(figure) {
            if (!figure.layout) figure.layout = {};
            figure.layout.plot_bgcolor = '#1E293B';
            figure.layout.paper_bgcolor = '#1E293B';
            figure.layout.font = { color: '#E2E8F0' };
            figure.layout.xaxis = figure.layout.xaxis || {};
            figure.layout.yaxis = figure.layout.yaxis || {};
            figure.layout.xaxis.gridcolor = '#334155';
            figure.layout.yaxis.gridcolor = '#334155';
            figure.layout.xaxis.linecolor = '#334155';
            figure.layout.yaxis.linecolor = '#334155';
            return figure;
        }

        try {
            // CORRECTO: Usamos el filtro `tojson` para inyectar los datos de forma segura.
            let graphsData = {{ graphs_json | tojson }};
            
            let accuracyFigure = applyDarkTheme(graphsData.accuracy);
            let lossFigure = applyDarkTheme(graphsData.loss);
            let confusionMatrixFigure = applyDarkTheme(graphsData.confusion_matrix);

            Plotly.newPlot('accuracy-chart', accuracyFigure.data, accuracyFigure.layout, {responsive: true});
            Plotly.newPlot('loss-chart', lossFigure.data, lossFigure.layout, {responsive: true});
            Plotly.newPlot('confusion-matrix-chart', confusionMatrixFigure.data, confusionMatrixFigure.layout, {responsive: true});

        } catch (e) {
            console.error("Error al renderizar los gráficos de Plotly:", e);
        }

        // --- 3. LÓGICA DE PREDICCIÓN Y FIREBASE ---
        const uploadArea = document.getElementById('upload-area');
        const imageUpload = document.getElementById('image-upload');
        const imagePreview = document.getElementById('image-preview');
        const predictionResult = document.getElementById('prediction-result');
        const saveButton = document.getElementById('save-button');
        const statusMessage = document.getElementById('status-message');

        if (uploadArea) {
            let currentFile = null;
            let currentPrediction = null;

            uploadArea.addEventListener('click', () => imageUpload.click());
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#38BDF8';
            });
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#334155';
            });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#334155';
                if (e.dataTransfer.files.length > 0) {
                    imageUpload.files = e.dataTransfer.files;
                    handleImageUpload({ target: imageUpload });
                }
            });
            imageUpload.addEventListener('change', handleImageUpload);
            saveButton.addEventListener('click', saveToFirebase);

            async function handleImageUpload(event) {
                currentFile = event.target.files[0];
                if (!currentFile) return;

                saveButton.disabled = true;
                statusMessage.textContent = '';

                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                };
                reader.readAsDataURL(currentFile);

                const formData = new FormData();
                formData.append('image', currentFile);

                predictionResult.textContent = 'Analizando...';

                try {
                    const response = await fetch('/predict', { method: 'POST', body: formData });
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Error en la respuesta del servidor');
                    }
                    const data = await response.json();
                    currentPrediction = data.prediction;
                    predictionResult.textContent = currentPrediction;
                    saveButton.disabled = false; // Habilitar el botón de guardar

                } catch (error) {
                    console.error('Error en la predicción:', error);
                    predictionResult.textContent = 'Error';
                    statusMessage.textContent = `Error al predecir: ${error.message}`;
                }
            }

            async function saveToFirebase() {
                if (!currentFile || currentPrediction === null) {
                    alert('Primero debes subir una imagen y obtener una predicción.');
                    return;
                }

                saveButton.disabled = true;
                statusMessage.textContent = 'Guardando en Firebase...';

                try {
                    // 1. Subir imagen a Firebase Storage
                    const filePath = `uploads/${Date.now()}_${currentFile.name}`;
                    const fileRef = storage.ref(filePath);
                    const snapshot = await fileRef.put(currentFile);
                    const downloadURL = await snapshot.ref.getDownloadURL();

                    // 2. Guardar datos en Firestore
                    await db.collection('predictions').add({
                        image_url: downloadURL,
                        predicted_digit: currentPrediction,
                        created_at: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    statusMessage.textContent = '¡Resultado guardado en Firebase con éxito!';
                    currentFile = null;
                    currentPrediction = null;
                    
                    setTimeout(() => {
                       imagePreview.style.display = 'none';
                       predictionResult.textContent = '...';
                       statusMessage.textContent = '';
                       uploadArea.style.borderColor = '#334155';
                       saveButton.disabled = false;
                    }, 3000);


                } catch (error) {
                    console.error('Error al guardar en Firebase:', error);
                    statusMessage.textContent = `Error al guardar: ${error.message}`;
                    saveButton.disabled = false;
                }
            }
        }
    });
    </script>
</body>
</html>