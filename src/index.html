<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análisis y Demo | MNIST AI</title>
    
    <!-- SDKs de Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

    <!-- Plotly -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <link rel="stylesheet" href="/static/decoracion.css">

</head>
<body>
    <div class="container">
        <header class="card">
            <h1>Análisis y Demo de IA para MNIST</h1>
            <p>Esta es una plataforma completa para analizar el rendimiento de un modelo de IA en el dataset MNIST y probarlo con tus propias imágenes.</p>
        </header>

        <main>
            <!-- SECCIÓN DE PREDICCIÓN INTERACTIVA CON FIREBASE -->
            <section class="card prediction-section">
                <h2>¡Prueba la IA y Guarda el Resultado!</h2>
                <p>Sube una imagen de un número manuscrito. La IA predecirá el dígito y podrás guardar la imagen y el resultado en Firebase.</p>
                <div id="upload-area" class="upload-area">
                    <p>Haz clic aquí o arrastra una imagen</p>
                    <input type="file" id="image-upload" accept="image/*" style="display: none;">
                </div>
                <img id="image-preview" src="" alt="Vista previa de la imagen" style="display:none;"/>
                <h3>Predicción de la IA:</h3>
                <div id="prediction-result">...</div>
                <button id="save-button" class="action-button" disabled>Guardar Resultado en Firebase</button>
                <div id="status-message"></div>
            </section>

            <!-- GRÁFICAS DE PLOTLY -->
            <section class="card">
                <h2>Rendimiento del Modelo: Precisión y Pérdida</h2>
                <p>Las siguientes gráficas muestran la evolución del modelo durante el entrenamiento, evidenciando el sobreajuste (overfitting).</p>
                <div class="grid">
                    <div id="accuracy-chart"></div>
                    <div id="loss-chart"></div>
                </div>
            </section>

            <section class="card">
                <h2>Análisis de Errores: Matriz de Confusión</h2>
                <p>La matriz de confusión revela los aciertos (diagonal) y los errores específicos de clasificación del modelo.</p>
                <div id="confusion-matrix-chart"></div>
                <p class="final-accuracy">{{ final_accuracy }}</p>
            </section>

            <section class="card">
                <h2>Ejemplos de Predicciones</h2>
                <p>Aciertos (verde) y errores (rojo) del modelo sobre el conjunto de prueba.</p>
                <div class="image-gallery">
                    {% for sample in sample_images %}
                    <div class="sample-item">
                        <img src="{{ sample.image }}" alt="Dígito {{ sample.true_label }}">
                        <div class="prediction-label {% if sample.predicted_label == sample.true_label %}prediction-correct{% else %}prediction-incorrect{% endif %}">
                            Real: {{ sample.true_label }} | Pred: {{ sample.predicted_label }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </section>

            <section class="card">
                <h2>Detalles Técnicos del Modelo</h2>
                <h3>Arquitectura</h3>
                <pre>{{ model_summary }}</pre>
                <h3>Logs de Entrenamiento</h3>
                <pre>{% for log in training_logs %}{{ log }}
{% endfor %}</pre>
            </section>
        </main>
    </div>

    <script>
        // --- 1. INICIALIZACIÓN DE FIREBASE ---
        // TODO: Pega aquí tu objeto de configuración de Firebase
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "TU_AUTH_DOMAIN",
            projectId: "TU_PROJECT_ID",
            storageBucket: "TU_STORAGE_BUCKET",
            messagingSenderId: "TU_MESSAGING_SENDER_ID",
            appId: "TU_APP_ID"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();
        const db = firebase.firestore();

        // --- 2. RENDERIZADO DE GRÁFICOS PLOTLY ---
        try {
            const graphsData = {{ graphs_json | tojson_safe }};
            Plotly.newPlot('accuracy-chart', graphsData.accuracy.data, graphsData.accuracy.layout);
            Plotly.newPlot('loss-chart', graphsData.loss.data, graphsData.loss.layout);
            Plotly.newPlot('confusion-matrix-chart', graphsData.confusion_matrix.data, graphsData.confusion_matrix.layout);
        } catch (e) {
            console.error("Error al renderizar los gráficos de Plotly:", e);
        }
        
        // --- 3. LÓGICA DE PREDICCIÓN Y FIREBASE ---
        const uploadArea = document.getElementById('upload-area');
        const imageUpload = document.getElementById('image-upload');
        const imagePreview = document.getElementById('image-preview');
        const predictionResult = document.getElementById('prediction-result');
        const saveButton = document.getElementById('save-button');
        const statusMessage = document.getElementById('status-message');

        let currentFile = null;
        let currentPrediction = null;

        uploadArea.addEventListener('click', () => imageUpload.click());
        uploadArea.addEventListener('dragover', (e) => e.preventDefault());
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            imageUpload.files = e.dataTransfer.files;
            handleImageUpload({ target: imageUpload });
        });
        imageUpload.addEventListener('change', handleImageUpload);
        saveButton.addEventListener('click', saveToFirebase);

        async function handleImageUpload(event) {
            currentFile = event.target.files[0];
            if (!currentFile) return;

            saveButton.disabled = true;
            statusMessage.textContent = '';
            
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                imagePreview.style.display = 'block';
            };
            reader.readAsDataURL(currentFile);

            const formData = new FormData();
            formData.append('image', currentFile);
            
            predictionResult.textContent = 'Analizando...';

            try {
                const response = await fetch('/predict', { method: 'POST', body: formData });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Error en la respuesta del servidor');
                }
                const data = await response.json();
                currentPrediction = data.prediction;
                predictionResult.textContent = currentPrediction;
                saveButton.disabled = false; // Habilitar el botón de guardar

            } catch (error) {
                console.error('Error en la predicción:', error);
                predictionResult.textContent = 'Error';
                statusMessage.textContent = `Error al predecir: ${error.message}`;
            }
        }

        async function saveToFirebase() {
            if (!currentFile || currentPrediction === null) {
                alert('Primero debes subir una imagen y obtener una predicción.');
                return;
            }
            if (firebaseConfig.apiKey === "TU_API_KEY") {
                 alert("Error: Debes configurar tus credenciales de Firebase en el archivo index.html");
                 return;
            }

            saveButton.disabled = true;
            statusMessage.textContent = 'Guardando en Firebase...';

            try {
                // 1. Subir imagen a Firebase Storage
                const filePath = `uploads/${Date.now()}_${currentFile.name}`;
                const fileRef = storage.ref(filePath);
                const snapshot = await fileRef.put(currentFile);
                const downloadURL = await snapshot.ref.getDownloadURL();

                // 2. Guardar datos en Firestore
                await db.collection('predictions').add({
                    image_url: downloadURL,
                    predicted_digit: currentPrediction,
                    created_at: firebase.firestore.FieldValue.serverTimestamp()
                });

                statusMessage.textContent = '¡Resultado guardado en Firebase con éxito!';
                console.log('Guardado exitoso!');

            } catch (error) {
                console.error('Error al guardar en Firebase:', error);
                statusMessage.textContent = `Error al guardar: ${error.message}`;
                saveButton.disabled = false;
            }
        }
    </script>
</body>
</html>